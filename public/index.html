<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Catch the Coin — Mini App</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: #050b14;
      --panel: #0c1324;
      --accent: #1dd4a8;
      --accent-2: #66e3ff;
      --text: #e9f4ff;
      --muted: #7f93b5;
      --danger: #ff7b7b;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: radial-gradient(circle at 20% 20%, rgba(102, 227, 255, 0.08), transparent 30%),
                  radial-gradient(circle at 80% 0%, rgba(29, 212, 168, 0.12), transparent 38%),
                  var(--bg);
      color: var(--text);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    .wrap {
      width: min(560px, 100%);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      background: var(--panel);
      border: 1px solid rgba(255, 255, 255, 0.06);
      padding: 10px 12px;
      border-radius: 14px;
      box-shadow: 0 14px 40px rgba(0, 0, 0, 0.35);
    }
    .title { font-weight: 700; letter-spacing: 0.2px; }
    .badge {
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 14px;
      color: var(--muted);
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    canvas {
      width: 100%;
      height: auto;
      aspect-ratio: 9 / 16;
      background: #071020;
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      box-shadow: 0 18px 60px rgba(0, 0, 0, 0.45);
      image-rendering: pixelated;
      touch-action: none;
    }
    .hud {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
    }
    .pill {
      background: var(--panel);
      border: 1px solid rgba(255, 255, 255, 0.06);
      border-radius: 12px;
      padding: 10px;
      font-weight: 600;
      text-align: center;
      color: var(--text);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.03);
    }
    .controls {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
      margin-top: 4px;
    }
    button {
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 10px;
      background: linear-gradient(135deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.35);
      transition: border-color 0.2s ease, transform 0.08s ease;
    }
    button:active { transform: translateY(1px) scale(0.99); }
    button.primary { background: linear-gradient(135deg, var(--accent), var(--accent-2)); color: #04141a; }
    button.danger { border-color: rgba(255, 123, 123, 0.4); color: var(--danger); }
    .promo {
      background: linear-gradient(135deg, rgba(29, 212, 168, 0.16), rgba(102, 227, 255, 0.16));
      border: 1px dashed rgba(255, 255, 255, 0.15);
      border-radius: 14px;
      padding: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      opacity: 0;
      transform: translateY(6px);
      pointer-events: none;
      transition: opacity 0.25s ease, transform 0.25s ease;
    }
    .promo.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }
    .promo-code {
      font-family: "JetBrains Mono", "SFMono-Regular", Consolas, monospace;
      background: rgba(255, 255, 255, 0.06);
      padding: 8px 10px;
      border-radius: 10px;
      letter-spacing: 1.2px;
    }
    @media (max-width: 480px) {
      body { padding: 12px; }
      header { flex-direction: column; align-items: flex-start; }
      .title { font-size: 15px; }
      .badge { width: 100%; justify-content: center; }
    }
  </style>
  <script defer src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="title">Catch the Coin · Мини-игра</div>
      <div class="badge">Собери 10 монет — получи промокод</div>
    </header>

    <canvas id="game" width="360" height="640"></canvas>

    <div class="hud">
      <div class="pill" id="score">Монеты: 0</div>
      <div class="pill" id="streak">Серия: 0x</div>
      <div class="pill" id="status">Готов?</div>
    </div>

    <div class="controls">
      <button id="left">◀︎ Влево</button>
      <button id="restart" class="danger">↺ Рестарт</button>
      <button id="right">Вправо ▶︎</button>
      <button id="tap" class="primary" style="grid-column: span 3;">Тапни/двигай — корзинка следует за пальцем</button>
    </div>

    <div class="promo" id="promo">
      <div>
        <div style="font-weight:700;">Промокод за 10 USDT</div>
        <div class="promo-code" id="promoCode">COIN-BOOST-2024</div>
      </div>
      <button class="primary" id="copy">Скопировать</button>
    </div>
  </div>

  <script>
    // Минимальная интеграция с Telegram Mini App
    (function initTelegram() {
      const tg = window.Telegram?.WebApp;
      try {
        tg?.ready();
        tg?.expand();
        tg?.setHeaderColor?.("secondary_bg_color");
        tg?.setBackgroundColor?.("#050b14");
      } catch (err) { console.warn(err); }
    })();

    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    let dpr = window.devicePixelRatio || 1;

    function resizeCanvas() {
      const rect = canvas.getBoundingClientRect();
      dpr = window.devicePixelRatio || 1;
      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    const state = {
      playing: true,
      score: 0,
      streak: 0,
      target: 10,
      promoUnlocked: false,
    };

    const groundY = 580; // in CSS pixels (before dpr)
    const basket = { x: 180, y: groundY - 36, w: 90, h: 32, speed: 320, vx: 0 };
    const coins = [];
    let lastSpawn = 0;
    const spawnEvery = 900;

    const keys = new Set();

    function drawBackground() {
      const cw = canvas.width / dpr;
      const ch = canvas.height / dpr;

      ctx.fillStyle = '#061020';
      ctx.fillRect(0, 0, cw, ch);

      ctx.save();
      ctx.globalAlpha = 0.12;
      ctx.fillStyle = '#1dd4a8';
      for (let i = 0; i < 30; i++) {
        const x = (i * 90 + performance.now() * 0.02) % (cw + 120) - 60;
        const y = (i * 60) % 320 + 12;
        ctx.fillRect(x, y, 3, 3);
      }
      ctx.globalAlpha = 1;
      ctx.restore();

      ctx.fillStyle = '#0e172d';
      ctx.fillRect(0, groundY + 12, cw, ch);
    }

    function drawBasket() {
      ctx.save();
      ctx.translate(basket.x, basket.y);
      ctx.fillStyle = '#0b192d';
      ctx.fillRect(-basket.w / 2, 0, basket.w, basket.h);
      ctx.fillStyle = '#22ffcc';
      ctx.fillRect(-basket.w / 2, -6, basket.w, 10);
      ctx.fillStyle = '#0f4138';
      ctx.fillRect(-basket.w / 2 + 6, 8, basket.w - 12, basket.h - 12);
      ctx.restore();
    }

    function spawnCoin(now) {
      const size = 26;
      const x = Math.random() * (canvas.width / dpr - size * 2) + size;
      const speed = 140 + Math.random() * 120;
      coins.push({ x, y: -20, r: size / 2, vy: speed, rot: Math.random() * Math.PI * 2, spin: 0.015 + Math.random() * 0.012 });
      lastSpawn = now;
    }

    function drawCoin(c) {
      ctx.save();
      ctx.translate(c.x, c.y);
      ctx.rotate(c.rot);
      const r = c.r;
      const inset = r * 0.24;
      const grd = ctx.createRadialGradient(-r * 0.3, -r * 0.3, r * 0.2, 0, 0, r);
      grd.addColorStop(0, '#5affd4');
      grd.addColorStop(1, '#0b8c74');
      ctx.fillStyle = grd;
      ctx.beginPath();
      ctx.arc(0, 0, r, 0, Math.PI * 2);
      ctx.fill();
      ctx.lineWidth = 3;
      ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
      ctx.stroke();

      ctx.fillStyle = '#ffffff';
      ctx.save();
      ctx.scale(0.9, 0.9);
      ctx.fillRect(-r * 0.6, -inset * 0.4, r * 1.2, inset * 0.8);
      ctx.fillRect(-inset * 0.5, -inset * 0.4, inset, r * 1.1);
      ctx.clearRect(-inset * 1.3, inset * 0.2, inset * 2.6, inset * 0.6);
      ctx.restore();
      ctx.restore();
    }

    function drawHUD() {
      document.getElementById('score').textContent = `Монеты: ${state.score}`;
      document.getElementById('streak').textContent = `Серия: ${state.streak}x`;
      document.getElementById('status').textContent = state.promoUnlocked
        ? 'Промокод открыт!'
        : state.playing
          ? 'Лови монеты'
          : 'Пауза';
    }

    function update(dt, now) {
      const canvasWidth = canvas.width / dpr;

      // управление
      basket.vx = 0;
      if (keys.has('ArrowLeft') || keys.has('KeyA')) basket.vx -= basket.speed;
      if (keys.has('ArrowRight') || keys.has('KeyD')) basket.vx += basket.speed;
      basket.x += basket.vx * dt;
      basket.x = Math.max(basket.w / 2 + 6, Math.min(canvasWidth - basket.w / 2 - 6, basket.x));

      if (now - lastSpawn > spawnEvery && state.playing && !state.promoUnlocked) spawnCoin(now);

      for (let i = coins.length - 1; i >= 0; i--) {
        const c = coins[i];
        c.y += c.vy * dt;
        c.rot += c.spin * Math.PI * 2;
        if (c.y > groundY + 18) {
          coins.splice(i, 1);
          state.streak = 0;
          continue;
        }
        const withinX = Math.abs(c.x - basket.x) < basket.w * 0.55;
        const withinY = c.y + c.r > basket.y && c.y - c.r < basket.y + basket.h;
        if (withinX && withinY) {
          coins.splice(i, 1);
          state.score += 1;
          state.streak += 1;
          if (state.score >= state.target) unlockPromo();
        }
      }
    }

    function render() {
      drawBackground();
      coins.forEach(drawCoin);
      drawBasket();
      drawHUD();
    }

    let lastTime = performance.now();
    function loop(now) {
      const dt = Math.min((now - lastTime) / 1000, 0.033);
      lastTime = now;
      if (state.playing) update(dt, now);
      render();
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);

    function unlockPromo() {
      state.promoUnlocked = true;
      document.getElementById('promo').classList.add('visible');
      document.getElementById('status').textContent = 'Промокод открыт!';
    }

    function resetGame() {
      state.score = 0;
      state.streak = 0;
      state.promoUnlocked = false;
      coins.splice(0, coins.length);
      lastSpawn = 0;
      document.getElementById('promo').classList.remove('visible');
      drawHUD();
    }

    // управление с клавиатуры и мыши/тач
    window.addEventListener('keydown', (e) => { keys.add(e.code); if (['ArrowLeft','ArrowRight','Space'].includes(e.code)) e.preventDefault(); });
    window.addEventListener('keyup', (e) => keys.delete(e.code));
    canvas.addEventListener('pointermove', (e) => {
      const rect = canvas.getBoundingClientRect();
      basket.x = (e.clientX - rect.left);
    });
    canvas.addEventListener('pointerdown', (e) => {
      const rect = canvas.getBoundingClientRect();
      basket.x = (e.clientX - rect.left);
    });

    document.getElementById('left').addEventListener('pointerdown', () => keys.add('ArrowLeft'));
    document.getElementById('right').addEventListener('pointerdown', () => keys.add('ArrowRight'));
    document.getElementById('left').addEventListener('pointerup', () => keys.delete('ArrowLeft'));
    document.getElementById('right').addEventListener('pointerup', () => keys.delete('ArrowRight'));
    document.getElementById('restart').addEventListener('click', resetGame);
    document.getElementById('tap').addEventListener('click', () => state.playing = true);

    document.getElementById('copy').addEventListener('click', async () => {
      const code = document.getElementById('promoCode').textContent.trim();
      try {
        await navigator.clipboard.writeText(code);
        document.getElementById('status').textContent = 'Промокод скопирован';
      } catch (err) {
        alert('Скопируй вручную: ' + code);
      }
    });
  </script>
</body>
</html>
