<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>Crypto Cat Runner ‚Äî Mini App</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-left: env(safe-area-inset-left, 0px);
    --safe-right: env(safe-area-inset-right, 0px);
  }
  html,body{
    margin:0; height:100%; background:#0b1020; color:#e7f3ff; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    overscroll-behavior:none; touch-action:manipulation;
  }
  /* –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ö–æ–ª—Å—Ç */
  #wrap{
    position:fixed; inset:0; display:grid; grid-template-rows: 1fr auto;
    padding:var(--safe-top) var(--safe-right) calc(var(--safe-bottom) + 72px) var(--safe-left);
  }
  canvas{
    position:fixed; inset:0;
    width:100vw; height:100vh; display:block; background:#0a0f1e; image-rendering:pixelated;
  }
  /* HUD —Å—á—ë—Ç—á–∏–∫ */
  .hud{
    position:fixed; left:12px; top:calc(8px + var(--safe-top));
    background:#0f1730; border:1px solid #1e2747; border-radius:999px; padding:6px 12px; font-weight:600; font-size:14px;
    pointer-events:none;
  }
  /* –ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ */
  .controls{
    position:fixed; left:0; right:0; bottom:0;
    padding:8px calc(12px + var(--safe-right)) calc(8px + var(--safe-bottom)) calc(12px + var(--safe-left));
    background:linear-gradient(180deg, rgba(11,16,32,0) 0%, rgba(11,16,32,0.85) 30%, rgba(11,16,32,0.95) 100%);
    display:flex; gap:10px; justify-content:center;
  }
  .btn{
    flex:1 1 0; max-width:220px;
    border:1px solid #1e2747; background:#162041; color:#e7f3ff;
    border-radius:14px; padding:14px 16px; font-weight:700; font-size:16px; text-align:center;
    user-select:none; -webkit-tap-highlight-color: transparent;
  }
  .btn:active{ transform:translateY(1px); opacity:.9; }
  .btn.secondary{ background:#0f1730; }
  .btn.warn{ background:#2a1030; border-color:#432a59; }
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game"></canvas>
</div>
<div class="hud">–ú–æ–Ω–µ—Ç—ã: <span id="coins">0</span></div>
<div class="controls">
  <div class="btn" id="btnRestart">‚ü≤ –†–µ—Å—Ç–∞—Ä—Ç</div>
  <div class="btn secondary" id="btnPause">‚è∏ –ü–∞—É–∑–∞</div>
  <div class="btn warn" id="btnColor">üé® –¶–≤–µ—Ç –∫–æ—Ç–∞</div>
</div>

<script>
/* ===== Telegram WebApp glue (no backend) ===== */
const tg = window.Telegram?.WebApp;
try { tg?.ready(); tg?.expand(); tg?.BackButton?.hide(); } catch(e){}
function updateMainButton(coins, alive){
  if (!tg) return;
  tg.MainButton.setParams({ text: `–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${coins} –º–æ–Ω–µ—Ç` });
  if (coins>0 && alive) tg.MainButton.show(); else tg.MainButton.hide();
}
function bindMainButton(getCoins, getAlive){
  if (!tg) return;
  tg.MainButton.onClick(() => {
    const payload = { type:'score', coins:getCoins(), ts:Date.now() };
    try { tg.HapticFeedback?.impactOccurred('medium'); } catch(_){}
    tg.sendData(JSON.stringify(payload));
  });
}
</script>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d', { alpha:true });
  let DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));

  // ==== –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã (–º–∞—Å—à—Ç–∞–± –æ—Ç –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞)
  let S = 1; // scale
  let GROUND_Y = 420;
  let GRAVITY = 0.9, JUMP_VELOCITY = -17;
  let START_SPEED = 6, SPEEDUP = 0.0009;
  const SPAWN_COOLDOWN = { coin: 1000, enemy: 1100 };
  const WORLD = { speed: START_SPEED, t: 0 };

  const coinsEl = document.getElementById('coins');
  const btnRestart = document.getElementById('btnRestart');
  const btnPause   = document.getElementById('btnPause');
  const btnColor   = document.getElementById('btnColor');

  let coins = 0, alive = true, paused = false;

  // –ö–æ—Ç Pico Park
  let CELL = 6;
  let CAT_W = 8*CELL, CAT_H = 9*CELL;
  const CAT_MAP = [
    [1,1,0,0,0,0,1,1],
    [1,1,1,1,1,1,1,1],
    [1,1,2,1,1,2,1,1],
    [1,1,1,1,1,1,1,1],
    [0,1,1,1,1,1,1,0],
    [0,0,1,1,1,1,0,0],
    [0,0,0,3,3,0,0,0],
    [0,0,1,0,0,1,0,0],
    [0,0,1,0,0,1,0,0],
  ];
  const CAT_COLORS = ['#f4a261','#5bb6ff','#ff9bb0','#ffd166','#8fff8b','#bba0ff'];
  let catColorIndex = 0;

  const player = { kind:'player', x:150, y:GROUND_Y, w:CAT_W, h:CAT_H, vy:0, onGround:true };
  const objects = { coins: [], enemies: [], particles: [] };
  let lastSpawn = { coin: 0, enemy: 0 };

  // === helpers
  const rand = (a,b)=>Math.random()*(b-a)+a;
  const getRect = e => (e.kind==='player'||e.kind==='enemy')
    ? {x:e.x, y:e.y - e.h, w:e.w, h:e.h}
    : {x:e.x, y:e.y, w:e.w, h:e.h};
  function aabb(A,B){ const a=getRect(A), b=getRect(B);
    return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }

  function resize(){
    DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    canvas.width  = Math.floor(window.innerWidth * DPR);
    canvas.height = Math.floor(window.innerHeight * DPR);
    canvas.style.width  = '100vw';
    canvas.style.height = '100vh';
    ctx.setTransform(DPR,0,0,DPR,0,0); // –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø–∏–∫—Å–µ–ª–∏

    // –º–∞—Å—à—Ç–∞–± –æ—Ç –±–∞–∑–æ–≤–æ–π –≤—ã—Å–æ—Ç—ã 540
    S = window.innerHeight / 540;
    // –ü–µ—Ä–µ—Å—á—ë—Ç —Ä–∞–∑–º–µ—Ä–æ–≤/—Ñ–∏–∑–∏–∫–∏
    GROUND_Y      = Math.round(420 * S);
    GRAVITY       = 0.9 * S;
    JUMP_VELOCITY = -17 * S;
    START_SPEED   = 6 * S;
    SPEEDUP       = 0.0009 * S;
    WORLD.speed   = Math.max(WORLD.speed, START_SPEED);

    CELL = Math.round(6 * S);
    CAT_W = 8*CELL; CAT_H = 9*CELL;
    player.w = CAT_W; player.h = CAT_H;
    player.x = Math.round(150 * S);
    player.y = GROUND_Y;
  }

  function reset(){
    coins=0; coinsEl.textContent=coins; updateMainButton(coins,true);
    alive=true; paused=false;
    WORLD.speed=START_SPEED; WORLD.t=0;
    objects.coins.length=0; objects.enemies.length=0; objects.particles.length=0;
    Object.assign(player,{ x:Math.round(150*S), y:GROUND_Y, vy:0, onGround:true });
  }

  // === background
  function drawBackground(){
    ctx.fillStyle='#081326'; ctx.fillRect(0,0,canvas.width/DPR,canvas.height/DPR);
    ctx.globalAlpha=.5;
    for(let i=0;i<120;i++){
      const x=((i*83+WORLD.t*0.06)%(canvas.width/DPR+200))-100;
      const y=(i*53)%Math.round(260*S)+10;
      ctx.fillStyle='#5cc8ff'; ctx.fillRect(x,y,2,2);
    }
    ctx.globalAlpha=1;
    ctx.fillStyle='#0b152f'; ctx.fillRect(0,GROUND_Y,canvas.width/DPR,canvas.height/DPR-GROUND_Y);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ª–∏–Ω–∏–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞ –¥–ª—è –ª—É—á—à–µ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
    ctx.strokeStyle='rgba(255,255,255,0.1)';
    ctx.lineWidth=1;
    for(let i=0;i<5;i++){
      const y = GROUND_Y - (i+1) * Math.round(40*S);
      ctx.beginPath();
      ctx.moveTo(0, y);
      ctx.lineTo(canvas.width/DPR, y);
      ctx.stroke();
    }
  }

  // === draw cat
  function drawPicoCat(){
    const x0 = player.x, y0 = player.y - CAT_H;
    const BODY = CAT_COLORS[catColorIndex], EYE='#000', TOOTH='#fff';
    const px = player.w/8, py = player.h/9;

    for(let r=0;r<CAT_MAP.length;r++)
      for(let c=0;c<CAT_MAP[0].length;c++)
        if(CAT_MAP[r][c]){ ctx.fillStyle='#111'; ctx.fillRect(x0+c*px-1, y0+r*py-1, px+2, py+2); }
    for(let r=0;r<CAT_MAP.length;r++)
      for(let c=0;c<CAT_MAP[0].length;c++){
        const cell = CAT_MAP[r][c]; if(!cell) continue;
        ctx.fillStyle=(cell===1)?BODY:(cell===2)?EYE:TOOTH;
        ctx.fillRect(x0+c*px, y0+r*py, px, py);
      }
  }

  // === enemies
  function spawnEnemy(){
    const w=Math.round(44*S), h=Math.round(32*S);
    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –¥–∏—Å—Ç–∞–Ω—Ü–∏—é –ø–æ—è–≤–ª–µ–Ω–∏—è –≤—Ä–∞–≥–æ–≤ –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
    objects.enemies.push({ kind:'enemy', x:canvas.width/DPR+rand(200*S,300*S), y:GROUND_Y, w,h });
  }
  function drawEnemy(e){
    const top = e.y - e.h;
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–Ω—å –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
    ctx.fillStyle='rgba(255,0,0,0.3)'; 
    ctx.fillRect(e.x-2, top-2, e.w+4, e.h+4);
    
    // –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ –≤—Ä–∞–≥–∞
    ctx.fillStyle='#ff6666'; 
    ctx.fillRect(e.x, top, e.w, e.h);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –±–ª–∏–∫ –¥–ª—è –æ–±—ä—ë–º–∞
    ctx.fillStyle='rgba(255,255,255,0.3)'; 
    ctx.fillRect(e.x+2, top+2, e.w-4, 4);
    
    // –ì–ª–∞–∑ –≤—Ä–∞–≥–∞
    ctx.fillStyle='#3a0f0f'; 
    ctx.fillRect(e.x+e.w/2-3, top+Math.round(8*S), 6, 6);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –∫—Ä–∞—Å–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
    if (e.x < canvas.width/DPR + 100*S) {
      ctx.globalAlpha = 0.4 * (1 - (e.x - canvas.width/DPR) / (100*S));
      ctx.fillStyle='#ff0000'; 
      ctx.fillRect(e.x-10, top-10, e.w+20, e.h+20);
      ctx.globalAlpha = 1;
    }
  }

  // === coins
  const COIN_SKINS = ['USDT','BTC','TON'];
  function spawnCoin(){
    const r=Math.round(16*S), top=GROUND_Y - Math.round(80*S) - Math.random()*Math.round(110*S);
    const skin=COIN_SKINS[Math.floor(Math.random()*COIN_SKINS.length)];
    objects.coins.push({ kind:'coin', x:canvas.width/DPR+rand(0,120*S), y:top, w:r*2, h:r*2, r,
      skin, spin:rand(0,1000), shimmer:rand(0,1000) });
  }
  function coinPalette(s){
    switch(s){
      case 'USDT': return { inner:'#22ffcc', outer:'#008f73', logo:'#ffffff' };
      case 'BTC':  return { inner:'#ffb347', outer:'#d78100', logo:'#1a1a1a' };
      case 'TON':  return { inner:'#53b6ff', outer:'#0b6ed1', logo:'#ffffff' };
      default:     return { inner:'#ffd94d', outer:'#b88400', logo:'#ffffff' };
    }
  }
  function drawCoinLogo(s){
    switch(s){
      case 'USDT':
        ctx.fillRect(-12*S,-2*S,24*S,4*S); ctx.fillRect(-3*S,-2*S,6*S,16*S); ctx.clearRect(-9*S,6*S,18*S,4*S); break;
      case 'BTC':
        ctx.fillRect(-3*S,-12*S,6*S,24*S);
        ctx.beginPath(); ctx.arc(0,-6*S,8*S,Math.PI*0.9,Math.PI*0.1,false);
        ctx.arc(0, 6*S,8*S,Math.PI*0.9,Math.PI*0.1,false); ctx.fill(); break;
      case 'TON':
        ctx.beginPath(); ctx.moveTo(0,-10*S); ctx.lineTo(10*S,0); ctx.lineTo(0,12*S); ctx.lineTo(-10*S,0); ctx.closePath();
        ctx.strokeStyle=ctx.fillStyle; ctx.stroke(); break;
    }
  }
  function drawCoin(c){
    const {x,y,r,skin}=c, pal=coinPalette(skin);
    const squash=0.12*Math.sin((WORLD.t+c.spin)*0.01);
    ctx.save(); ctx.translate(x+r, y+r); ctx.scale(1+squash,1-squash);
    ctx.rotate(((WORLD.t+c.spin)*0.006)%(Math.PI*2));
    const g=ctx.createRadialGradient(0,0,r*0.25,0,0,r); g.addColorStop(0,pal.inner); g.addColorStop(1,pal.outer);
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,.35)'; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(0,0,r-1.5,0,Math.PI*2); ctx.stroke();
    ctx.save(); ctx.rotate(Math.PI*0.25);
    ctx.globalAlpha=0.25+0.35*((Math.sin((WORLD.t+c.shimmer)*0.008)+1)/2);
    const grd=ctx.createLinearGradient(-r,-r,r,r);
    grd.addColorStop(0,'rgba(255,255,255,0)'); grd.addColorStop(0.5,'rgba(255,255,255,0.8)'); grd.addColorStop(1,'rgba(255,255,255,0)');
    ctx.fillStyle=grd; ctx.fillRect(-r,-r,r*2,r*2); ctx.restore();
    ctx.fillStyle=pal.logo; ctx.strokeStyle=pal.logo; drawCoinLogo(skin);
    ctx.restore();
  }

  // === particles (–ª–∞–∫–æ–Ω–∏—á–Ω–æ)
  function spawnBurst(x,y,color,count=8){
    for(let i=0;i<count;i++)
      objects.particles.push({x,y,vx:rand(-2*S,2*S),vy:rand(-3*S,-1*S),t:0,life:rand(300,700),color});
  }
  function drawParticles(dt){
    for(let i=objects.particles.length-1;i>=0;i--){
      const p=objects.particles[i];
      p.t+=dt; p.x+=p.vx; p.y+=p.vy; p.vy+=0.08*S;
      const a=Math.max(0,1-p.t/p.life);
      if(a<=0){ objects.particles.splice(i,1); continue; }
      ctx.globalAlpha=a; ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,3,3); ctx.globalAlpha=1;
    }
  }

  // === input
  const jump = ()=>{ if(alive && player.onGround){ player.vy=JUMP_VELOCITY; player.onGround=false; } };
  canvas.addEventListener('pointerdown', jump, { passive:true });
  document.addEventListener('keydown', e=>{
    if(e.code==='Space'||e.code==='ArrowUp'){ e.preventDefault(); jump(); }
    if(e.code==='KeyR') reset();
    if(e.code==='KeyP') { paused=!paused; btnPause.textContent = paused ? '‚ñ∂ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å' : '‚è∏ –ü–∞—É–∑–∞'; }
    if(e.code==='KeyK') { catColorIndex=(catColorIndex+1)%CAT_COLORS.length; }
  });

  // === bottom buttons
  btnRestart.onclick = ()=>{ reset(); };
  btnPause.onclick   = ()=>{ paused=!paused; btnPause.textContent = paused ? '‚ñ∂ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å' : '‚è∏ –ü–∞—É–∑–∞'; };
  btnColor.onclick   = ()=>{ catColorIndex=(catColorIndex+1)%CAT_COLORS.length; };

  // === loop
  let last = performance.now();
  function loop(now){
    const dt = now - last; last = now;

    if(!paused && alive){
      WORLD.t += dt;
      WORLD.speed += SPEEDUP * dt;

      if(now - lastSpawn.coin  > SPAWN_COOLDOWN.coin)  { spawnCoin();  lastSpawn.coin=now; }
      if(now - lastSpawn.enemy > SPAWN_COOLDOWN.enemy) { spawnEnemy(); lastSpawn.enemy=now; }

      player.vy += GRAVITY; player.y += player.vy;
      if(player.y >= GROUND_Y){ player.y=GROUND_Y; player.vy=0; player.onGround=true; }

      for(let i=objects.coins.length-1;i>=0;i--){
        const c=objects.coins[i]; c.x -= WORLD.speed;
        if(aabb(c,player)){
          coins++; coinsEl.textContent=coins; updateMainButton(coins, alive);
          spawnBurst(c.x+c.r, c.y+c.r, 'rgba(255,255,255,.9)', 10);
          objects.coins.splice(i,1);
        } else if(c.x + c.w < -10) objects.coins.splice(i,1);
      }
      for(let i=objects.enemies.length-1;i>=0;i--){
        const e=objects.enemies[i]; e.x -= WORLD.speed*1.05;
        if(aabb(e,player)){ 
          alive=false; 
          updateMainButton(coins, alive); 
          // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–∏
          spawnBurst(player.x + player.w/2, player.y - player.h/2, '#ff6666', 15);
        }
        else if(e.x + e.w < -10) objects.enemies.splice(i,1);
      }
    }

    // render
    ctx.clearRect(0,0,canvas.width/DPR,canvas.height/DPR);
    drawBackground();
    objects.coins.forEach(drawCoin);
    objects.enemies.forEach(drawEnemy);
    drawParticles(dt);
    drawPicoCat();

    if(!alive){
      ctx.fillStyle='#ffb3c0'; ctx.font=`${Math.round(18*S)}px system-ui, sans-serif`;
      ctx.fillText('–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞ ‚Äî –†–µ—Å—Ç–∞—Ä—Ç', Math.round(20*S), Math.round(40*S));
    }
    requestAnimationFrame(loop);
  }

  // init
  window.addEventListener('resize', resize);
  resize();
  reset();
  bindMainButton(()=>coins, ()=>alive);
  requestAnimationFrame(t=>{ last=t; loop(t); });
})();
</script>
</body>
</html>
