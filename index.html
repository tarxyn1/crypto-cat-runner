<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no" />
<title>Crypto Cat Runner ‚Äî Mini App</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  :root{
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-left: env(safe-area-inset-left, 0px);
    --safe-right: env(safe-area-inset-right, 0px);
  }
  html,body{
    margin:0; height:100%; background:#0b1020; color:#e7f3ff; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    overscroll-behavior:none; touch-action:manipulation;
  }
  /* –ü–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ö–æ–ª—Å—Ç */
  #wrap{
    position:fixed; inset:0; display:grid; grid-template-rows: 1fr auto;
    padding:var(--safe-top) var(--safe-right) calc(var(--safe-bottom) + 72px) var(--safe-left);
  }
  canvas{
    position:fixed; inset:0;
    width:100vw; height:100vh; display:block; background:#0a0f1e; image-rendering:pixelated;
  }
  /* HUD —Å—á—ë—Ç—á–∏–∫ */
  .hud{
    position:fixed; left:12px; top:calc(8px + var(--safe-top));
    background:#0f1730; border:1px solid #1e2747; border-radius:999px; padding:6px 12px; font-weight:600; font-size:14px;
    pointer-events:none;
  }
  /* –í–µ—Ä—Ö–Ω—è—è –ø–∞–Ω–µ–ª—å –∫–Ω–æ–ø–æ–∫ */
  .controls{
    position:fixed; right:12px; top:calc(12px + var(--safe-top));
    display:flex; gap:8px; flex-direction:column; max-height:60vh; overflow-y:auto;
  }
  .btn{
    border:1px solid #1e2747; background:#162041; color:#e7f3ff;
    border-radius:12px; padding:8px 12px; font-weight:600; font-size:14px; text-align:center;
    user-select:none; -webkit-tap-highlight-color: transparent; min-width:80px;
  }
  .btn:active{ transform:translateY(1px); opacity:.9; }
  .btn.secondary{ background:#0f1730; }
  .btn.warn{ background:#2a1030; border-color:#432a59; }
  
  /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –º–∏—Å—Å–∏–π */
  .mission-modal{
    position:fixed; inset:0; background:rgba(0,0,0,0.8); z-index:1000;
    display:none; align-items:center; justify-content:center;
    padding:20px;
  }
  .mission-grid{
    background:#0f1730; border:1px solid #1e2747; border-radius:16px;
    padding:20px; max-width:400px; width:100%;
    max-height:80vh; overflow-y:auto;
  }
  .mission-title{
    color:#e7f3ff; font-size:18px; font-weight:700; text-align:center;
    margin-bottom:20px;
  }
  .mission-list{
    display:grid; grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));
    gap:12px;
  }
  .mission-item{
    background:#162041; border:2px solid #1e2747; border-radius:12px;
    padding:12px; text-align:center; cursor:pointer;
    transition:all 0.2s; user-select:none;
  }
  .mission-item:hover{ border-color:#5cc8ff; background:#1a2a5a; }
  .mission-item.active{ border-color:#5cc8ff; background:#1a2a5a; }
  .mission-item .icon{ font-size:24px; margin-bottom:8px; }
  .mission-item .name{ color:#e7f3ff; font-size:14px; font-weight:600; margin-bottom:4px; }
  .mission-item .desc{ color:#8ba3c7; font-size:12px; }
  .mission-close{
    position:absolute; top:10px; right:10px; color:#e7f3ff;
    font-size:24px; cursor:pointer; padding:10px;
  }
</style>
</head>
<body>
<div id="wrap">
  <canvas id="game"></canvas>
</div>
<div class="hud">–ú–æ–Ω–µ—Ç—ã: <span id="coins">0</span></div>
<div class="controls">
  <div class="btn" id="btnRestart">‚ü≤ –†–µ—Å—Ç–∞—Ä—Ç</div>
  <div class="btn secondary" id="btnPause">‚è∏ –ü–∞—É–∑–∞</div>
  <div class="btn warn" id="btnColor">üé® –¶–≤–µ—Ç –∫–æ—Ç–∞</div>
  <div class="btn" id="btnMission">üéØ –ú–∏—Å—Å–∏–∏</div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –º–∏—Å—Å–∏–π -->
<div class="mission-modal" id="missionModal">
  <div class="mission-grid">
    <div class="mission-close" id="missionClose">√ó</div>
    <div class="mission-title">–í—ã–±–µ—Ä–∏—Ç–µ –º–∏—Å—Å–∏—é</div>
    <div class="mission-list" id="missionList">
      <!-- –ú–∏—Å—Å–∏–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã —á–µ—Ä–µ–∑ JavaScript -->
    </div>
  </div>
</div>

<script>
/* ===== Telegram WebApp glue (no backend) ===== */
const tg = window.Telegram?.WebApp;
try { tg?.ready(); tg?.expand(); tg?.BackButton?.hide(); } catch(e){}
function updateMainButton(coins, alive){
  if (!tg) return;
  // –£–±–∏—Ä–∞–µ–º –∫–Ω–æ–ø–∫—É "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç"
  tg.MainButton.hide();
}
function bindMainButton(getCoins, getAlive){
  if (!tg) return;
  // –£–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç"
}
</script>

<script>
(() => {
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d', { alpha:true });
  let DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));

  // ==== –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã (–º–∞—Å—à—Ç–∞–± –æ—Ç –≤—ã—Å–æ—Ç—ã —ç–∫—Ä–∞–Ω–∞)
  let S = 1; // scale
  let GROUND_Y = 420;
  let GRAVITY = 1.4, JUMP_VELOCITY = -20;
  let START_SPEED = 2, SPEEDUP = 0.0001;
  const SPAWN_COOLDOWN = { coin: 2000, enemy: 3000 };
  
  // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–µ–∫—É—â–∏—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å–ø–∞–≤–Ω–∞
  function getCurrentSpawnCooldown() {
    const mission = MISSIONS[currentMission];
    if (mission.type === "survive") {
      return { coin: 3000, enemy: 999999 }; // –í –º–∏—Å—Å–∏–∏ –≤—ã–∂–∏–≤–∞–Ω–∏—è –≤—Ä–∞–≥–∏ –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
    }
    return SPAWN_COOLDOWN;
  }
  const WORLD = { speed: START_SPEED, t: 0 };
  
  // –ú–∏—Å—Å–∏–∏ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å
  const MISSION_TIME = 120000; // 2 –º–∏–Ω—É—Ç—ã
  let missionProgress = 0;
  let missionStartTime = 0;
  let currentMission = 0;
  
  const MISSIONS = [
    {
      id: 0,
      name: "–í—Ä–µ–º—è –∏–¥—ë—Ç",
      description: "–ü—Ä–æ–¥–µ—Ä–∂–∏—Å—å 2 –º–∏–Ω—É—Ç—ã",
      type: "time",
      target: 120000,
      progress: 0,
      icon: "‚è±Ô∏è"
    },
    {
      id: 1,
      name: "–°–æ–±–µ—Ä–∏ USDT",
      description: "–°–æ–±–µ—Ä–∏ 5 USDT —Ç–æ–∫–µ–Ω–æ–≤",
      type: "collect",
      target: 5,
      targetCoin: "USDT",
      progress: 0,
      icon: "üíé"
    },
    {
      id: 2,
      name: "–ò–∑–±–µ–≥–∏ –≤—Ä–∞–≥–æ–≤",
      description: "–ü—Ä–æ–¥–µ—Ä–∂–∏—Å—å 2 –º–∏–Ω—É—Ç—ã –±–µ–∑ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π",
      type: "survive",
      target: 120000,
      progress: 0,
      icon: "üõ°Ô∏è"
    },
    {
      id: 3,
      name: "–¢–æ–ª—å–∫–æ –ø—Ä—ã–∂–∫–∏",
      description: "–°–æ–±–µ—Ä–∏ 8 –º–æ–Ω–µ—Ç, –Ω–µ —Å—Ç–æ–π –Ω–∞ –∑–µ–º–ª–µ –¥–æ–ª—å—à–µ 2—Å",
      type: "jump",
      target: 8,
      progress: 0,
      icon: "ü¶ò"
    },
    {
      id: 4,
      name: "–ì–æ–Ω–∫–∞ –∑–∞ –±–æ–Ω—É—Å–æ–º",
      description: "–î–æ–≥–æ–Ω–∏ –∑–æ–ª–æ—Ç—É—é –º–æ–Ω–µ—Ç—É –∑–∞ 90 —Å–µ–∫—É–Ω–¥",
      type: "chase",
      target: 90000,
      progress: 0,
      icon: "üèÉ"
    }
  ];

  const coinsEl = document.getElementById('coins');
  const btnRestart = document.getElementById('btnRestart');
  const btnPause   = document.getElementById('btnPause');
  const btnColor   = document.getElementById('btnColor');
  const btnMission = document.getElementById('btnMission');
  const missionModal = document.getElementById('missionModal');
  const missionList = document.getElementById('missionList');
  const missionClose = document.getElementById('missionClose');

  let coins = 0, alive = true, paused = false, missionActive = false;
  let groundTime = 0; // –í—Ä–µ–º—è –Ω–∞ –∑–µ–º–ª–µ –¥–ª—è –º–∏—Å—Å–∏–∏ –ø—Ä—ã–∂–∫–æ–≤

  // –ö–æ—Ç Pico Park
  let CELL = 6;
  let CAT_W = 8*CELL, CAT_H = 9*CELL;
  const CAT_MAP = [
    [1,1,0,0,0,0,1,1],
    [1,1,1,1,1,1,1,1],
    [1,1,2,1,1,2,1,1],
    [1,1,1,1,1,1,1,1],
    [0,1,1,1,1,1,1,0],
    [0,0,1,1,1,1,0,0],
    [0,0,0,3,3,0,0,0],
    [0,0,1,0,0,1,0,0],
    [0,0,1,0,0,1,0,0],
  ];
  const CAT_COLORS = ['#f4a261','#5bb6ff','#ff9bb0','#ffd166','#8fff8b','#bba0ff'];
  let catColorIndex = 0;

  const player = { kind:'player', x:80, y:GROUND_Y, w:CAT_W, h:CAT_H, vy:0, onGround:true, vx:0 };
  const objects = { coins: [], enemies: [], particles: [], platforms: [], bonus: null };
  let lastSpawn = { coin: 0, enemy: 0 };

  // === helpers
  const rand = (a,b)=>Math.random()*(b-a)+a;
  const getRect = e => (e.kind==='player'||e.kind==='enemy')
    ? {x:e.x, y:e.y - e.h, w:e.w, h:e.h}
    : {x:e.x, y:e.y, w:e.w, h:e.h};
  function aabb(A,B){ const a=getRect(A), b=getRect(B);
    return a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y; }

  function resize(){
    DPR = Math.max(1, Math.min(3, window.devicePixelRatio || 1));
    canvas.width  = Math.floor(window.innerWidth * DPR);
    canvas.height = Math.floor(window.innerHeight * DPR);
    canvas.style.width  = '100vw';
    canvas.style.height = '100vh';
    ctx.setTransform(DPR,0,0,DPR,0,0); // –ª–æ–≥–∏—á–µ—Å–∫–∏–µ –ø–∏–∫—Å–µ–ª–∏

    // –º–∞—Å—à—Ç–∞–± –æ—Ç –±–∞–∑–æ–≤–æ–π –≤—ã—Å–æ—Ç—ã 540
    S = window.innerHeight / 540;
    // –ü–µ—Ä–µ—Å—á—ë—Ç —Ä–∞–∑–º–µ—Ä–æ–≤/—Ñ–∏–∑–∏–∫–∏
    GROUND_Y      = Math.round(420 * S);
    GRAVITY       = 1.4 * S;
    JUMP_VELOCITY = -20 * S;
    START_SPEED   = 6 * S;
    SPEEDUP       = 0.0009 * S;
    WORLD.speed   = Math.max(WORLD.speed, START_SPEED);

    CELL = Math.round(6 * S);
    CAT_W = 8*CELL; CAT_H = 9*CELL;
    player.w = CAT_W; player.h = CAT_H;
    player.x = Math.round(80 * S);
    player.y = GROUND_Y;
  }

  function reset(){
    coins=0; coinsEl.textContent=coins; updateMainButton(coins,true);
    alive=true; paused=false; missionActive=true;
    WORLD.speed=START_SPEED; WORLD.t=0;
    missionProgress=0; missionStartTime=Date.now();
    groundTime=0;
    objects.coins.length=0; objects.enemies.length=0; objects.particles.length=0; objects.platforms.length=0;
    Object.assign(player,{ x:Math.round(80*S), y:GROUND_Y, vy:0, onGround:true, vx:0 });
    
    // –°–±—Ä–æ—Å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –º–∏—Å—Å–∏–∏
    MISSIONS[currentMission].progress = 0;
    
    // –°–æ–∑–¥–∞–µ–º –Ω–∞—á–∞–ª—å–Ω–æ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ –≤—Ä–∞–≥–æ–≤ –¥–ª—è –º–∏—Å—Å–∏–∏ –≤—ã–∂–∏–≤–∞–Ω–∏—è
    spawnInitialEnemies();
    
    // –°–æ–∑–¥–∞–µ–º –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã –¥–ª—è –º–∏—Å—Å–∏–∏ –ø—Ä—ã–∂–∫–æ–≤
    spawnJumpPlatforms();
    
    // –°–æ–∑–¥–∞–µ–º —É–±–µ–≥–∞—é—â–∏–π –±–æ–Ω—É—Å –¥–ª—è –º–∏—Å—Å–∏–∏ –≥–æ–Ω–∫–∏
    spawnChaseBonus();
  }

  // === background
  function drawBackground(){
    ctx.fillStyle='#081326'; ctx.fillRect(0,0,canvas.width/DPR,canvas.height/DPR);
    ctx.globalAlpha=.5;
    for(let i=0;i<120;i++){
      const x=((i*83+WORLD.t*0.06)%(canvas.width/DPR+200))-100;
      const y=(i*53)%Math.round(260*S)+10;
      ctx.fillStyle='#5cc8ff'; ctx.fillRect(x,y,2,2);
    }
    ctx.globalAlpha=1;
    ctx.fillStyle='#0b152f'; ctx.fillRect(0,GROUND_Y,canvas.width/DPR,canvas.height/DPR-GROUND_Y);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –ª–∏–Ω–∏–∏ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞ –¥–ª—è –ª—É—á—à–µ–π –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏
    ctx.strokeStyle='rgba(255,255,255,0.1)';
    ctx.lineWidth=1;
    for(let i=0;i<5;i++){
      const y = GROUND_Y - (i+1) * Math.round(40*S);
      ctx.beginPath();
      ctx.moveTo(0, y);
      ctx.lineTo(canvas.width/DPR, y);
      ctx.stroke();
    }
    
    // –ü—Ä–æ–º–æ-–±–∏–ª–±–æ—Ä–¥—ã –Ω–∞ –∑–∞–¥–Ω–µ–º –ø–ª–∞–Ω–µ
    drawPromoBillboards();
  }
  
  // –ü—Ä–æ–º–æ-–±–∏–ª–±–æ—Ä–¥—ã
  function drawPromoBillboards(){
    const billboards = [
      { x: 400, text: "üî• –ù–û–í–´–ï –ö–†–ò–ü–¢–û", subtext: "–ò–Ω–≤–µ—Å—Ç–∏—Ä—É–π —É–º–Ω–æ" },
      { x: 800, text: "üíé TON COIN", subtext: "–ë—É–¥—É—â–µ–µ –±–ª–æ–∫—á–µ–π–Ω–∞" },
      { x: 1200, text: "üöÄ –î–ï–§–ò –ü–†–û–¢–û–ö–û–õ–´", subtext: "–í—ã—Å–æ–∫–∏–µ APY" },
      { x: 1600, text: "üì± TELEGRAM WALLET", subtext: "–ë–µ–∑–æ–ø–∞—Å–Ω–æ –∏ –±—ã—Å—Ç—Ä–æ" }
    ];
    
    billboards.forEach(billboard => {
      const screenX = billboard.x - WORLD.t * WORLD.speed * 0.1;
      if (screenX > -200 && screenX < canvas.width/DPR + 200) {
        // –§–æ–Ω –±–∏–ª–±–æ—Ä–¥–∞
        ctx.fillStyle = 'rgba(15, 23, 48, 0.8)';
        ctx.fillRect(screenX, GROUND_Y - 120*S, 180*S, 80*S);
        
        // –†–∞–º–∫–∞
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.3)';
        ctx.lineWidth = 2;
        ctx.strokeRect(screenX, GROUND_Y - 120*S, 180*S, 80*S);
        
        // –¢–µ–∫—Å—Ç
        ctx.fillStyle = '#ffffff';
        ctx.font = `bold ${Math.round(14*S)}px system-ui`;
        ctx.textAlign = 'center';
        ctx.fillText(billboard.text, screenX + 90*S, GROUND_Y - 95*S);
        
        ctx.fillStyle = '#5cc8ff';
        ctx.font = `${Math.round(12*S)}px system-ui`;
        ctx.fillText(billboard.subtext, screenX + 90*S, GROUND_Y - 75*S);
        ctx.textAlign = 'left';
      }
    });
  }

  // === draw cat
  function drawPicoCat(){
    const x0 = player.x, y0 = player.y - CAT_H;
    const BODY = CAT_COLORS[catColorIndex], EYE='#000', TOOTH='#fff';
    const px = player.w/8, py = player.h/9;

    for(let r=0;r<CAT_MAP.length;r++)
      for(let c=0;c<CAT_MAP[0].length;c++)
        if(CAT_MAP[r][c]){ ctx.fillStyle='#111'; ctx.fillRect(x0+c*px-1, y0+r*py-1, px+2, py+2); }
    for(let r=0;r<CAT_MAP.length;r++)
      for(let c=0;c<CAT_MAP[0].length;c++){
        const cell = CAT_MAP[r][c]; if(!cell) continue;
        ctx.fillStyle=(cell===1)?BODY:(cell===2)?EYE:TOOTH;
        ctx.fillRect(x0+c*px, y0+r*py, px, py);
      }
  }

  // === enemies
  function spawnEnemy(){
    const w=Math.round(44*S), h=Math.round(32*S);
    const mission = MISSIONS[currentMission];
    
    if (mission.type === "survive") {
      // –í –º–∏—Å—Å–∏–∏ –≤—ã–∂–∏–≤–∞–Ω–∏—è –≤—Ä–∞–≥–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ —Å–ª—É—á–∞–π–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö –∏ –ø—Ä–µ—Å–ª–µ–¥—É—é—Ç –∏–≥—Ä–æ–∫–∞
      const spawnX = rand(50*S, canvas.width/DPR - 50*S);
      const spawnY = GROUND_Y - rand(50*S, 150*S);
      objects.enemies.push({ 
        kind:'enemy', 
        x: spawnX, 
        y: spawnY, 
        w, h,
        vx: 0,
        vy: 0,
        targetX: player.x,
        targetY: player.y,
        speed: rand(0.5*S, 1.5*S)
      });
    } else {
      // –û–±—ã—á–Ω—ã–µ –≤—Ä–∞–≥–∏ –ø–æ—è–≤–ª—è—é—Ç—Å—è —Å–ø—Ä–∞–≤–∞
      objects.enemies.push({ kind:'enemy', x:canvas.width/DPR+rand(200*S,300*S), y:GROUND_Y, w,h });
    }
  }
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞—á–∞–ª—å–Ω–æ–≥–æ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è –≤—Ä–∞–≥–æ–≤ –≤ –º–∏—Å—Å–∏–∏ –≤—ã–∂–∏–≤–∞–Ω–∏—è
  function spawnInitialEnemies() {
    const mission = MISSIONS[currentMission];
    if (mission.type === "survive") {
      // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –≤—Ä–∞–≥–æ–≤
      objects.enemies.length = 0;
      
      // –°–æ–∑–¥–∞–µ–º —Ç–æ–ª—å–∫–æ 3 –≤—Ä–∞–≥–∞, —Ä–∞–∑–±—Ä–æ—Å–∞–Ω–Ω—ã—Ö –ø–æ –ª–æ–∫–∞—Ü–∏–∏
      const enemyCount = 3;
      for (let i = 0; i < enemyCount; i++) {
        const w = Math.round(44*S), h = Math.round(32*S);
        
        // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –∑–æ–Ω–∞ –≤–æ–∫—Ä—É–≥ –∫–æ—Ç–∞ (150 –ø–∏–∫—Å–µ–ª–µ–π)
        const safeZone = 150*S;
        let spawnX, spawnY;
        let attempts = 0;
        
        do {
          spawnX = rand(50*S, canvas.width/DPR - 50*S);
          spawnY = GROUND_Y - rand(50*S, 200*S);
          attempts++;
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –∫–æ—Ç–∞
          const distanceToCat = Math.sqrt(
            Math.pow(spawnX - player.x, 2) + 
            Math.pow(spawnY - player.y, 2)
          );
          
          // –ï—Å–ª–∏ –≤—Ä–∞–≥ —Å–ª–∏—à–∫–æ–º –±–ª–∏–∑–∫–æ –∫ –∫–æ—Ç—É, –ø—Ä–æ–±—É–µ–º —Å–Ω–æ–≤–∞
          if (distanceToCat < safeZone) {
            continue;
          }
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –¥—Ä—É–≥–∏—Ö –≤—Ä–∞–≥–æ–≤
          let tooClose = false;
          for (let j = 0; j < objects.enemies.length; j++) {
            const existingEnemy = objects.enemies[j];
            const distanceToEnemy = Math.sqrt(
              Math.pow(spawnX - existingEnemy.x, 2) + 
              Math.pow(spawnY - existingEnemy.y, 2)
            );
            if (distanceToEnemy < 120*S) {
              tooClose = true;
              break;
            }
          }
          
          if (!tooClose) break;
          
        } while (attempts < 50); // –ú–∞–∫—Å–∏–º—É–º 50 –ø–æ–ø—ã—Ç–æ–∫
        
        objects.enemies.push({ 
          kind:'enemy', 
          x: spawnX, 
          y: spawnY, 
          w, h,
          vx: 0,
          vy: 0,
          targetX: player.x,
          targetY: player.y,
          speed: rand(0.8*S, 1.2*S),
          active: false, // –í—Ä–∞–≥ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ
          activationDistance: 100*S // –î–∏—Å—Ç–∞–Ω—Ü–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
        });
      }
    }
  }
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–ª–∞—Ç—Ñ–æ—Ä–º –≤ –º–∏—Å—Å–∏–∏ –ø—Ä—ã–∂–∫–æ–≤
  function spawnJumpPlatforms() {
    const mission = MISSIONS[currentMission];
    if (mission.type === "jump") {
      // –û—á–∏—â–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
      objects.platforms.length = 0;
      
      // –°–æ–∑–¥–∞–µ–º 6-8 –ø–ª–∞—Ç—Ñ–æ—Ä–º —Ä–∞–∑–Ω–æ–π –≤—ã—Å–æ—Ç—ã
      const platformCount = Math.floor(rand(6, 8));
      for (let i = 0; i < platformCount; i++) {
        const platformW = Math.round(rand(60*S, 120*S));
        const platformH = Math.round(12*S);
        
        let spawnX, spawnY;
        let attempts = 0;
        
        do {
          spawnX = rand(50*S, canvas.width/DPR - platformW - 50*S);
          spawnY = GROUND_Y - rand(80*S, 300*S);
          attempts++;
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –¥–æ –¥—Ä—É–≥–∏—Ö –ø–ª–∞—Ç—Ñ–æ—Ä–º
          let tooClose = false;
          for (let j = 0; j < objects.platforms.length; j++) {
            const existingPlatform = objects.platforms[j];
            const distanceX = Math.abs(spawnX - existingPlatform.x);
            const distanceY = Math.abs(spawnY - existingPlatform.y);
            
            if (distanceX < 100*S && distanceY < 80*S) {
              tooClose = true;
              break;
            }
          }
          
          if (!tooClose) break;
          
        } while (attempts < 30);
        
        objects.platforms.push({
          kind: 'platform',
          x: spawnX,
          y: spawnY,
          w: platformW,
          h: platformH
        });
      }
    }
  }
  
  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —É–±–µ–≥–∞—é—â–µ–≥–æ –±–æ–Ω—É—Å–∞
  function spawnChaseBonus() {
    const mission = MISSIONS[currentMission];
    if (mission.type === "chase") {
      // –°–æ–∑–¥–∞–µ–º –∑–æ–ª–æ—Ç—É—é –º–æ–Ω–µ—Ç—É, –∫–æ—Ç–æ—Ä–∞—è —É–±–µ–≥–∞–µ—Ç
      objects.bonus = {
        kind: 'bonus',
        x: canvas.width/DPR + 200*S,
        y: GROUND_Y - rand(50*S, 150*S),
        w: Math.round(32*S),
        h: Math.round(32*S),
        speed: WORLD.speed * 1.2, // –î–≤–∏–∂–µ—Ç—Å—è –±—ã—Å—Ç—Ä–µ–µ –∏–≥—Ä–æ–∫–∞
        spin: rand(0, 1000),
        shimmer: rand(0, 1000),
        caught: false
      };
    }
  }
  function drawEnemy(e){
    const top = e.y - e.h;
    const mission = MISSIONS[currentMission];
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–Ω—å –¥–ª—è –ª—É—á—à–µ–π –≤–∏–¥–∏–º–æ—Å—Ç–∏
    ctx.fillStyle='rgba(255,0,0,0.3)'; 
    ctx.fillRect(e.x-2, top-2, e.w+4, e.h+4);
    
    // –û—Å–Ω–æ–≤–Ω–æ–π –±–ª–æ–∫ –≤—Ä–∞–≥–∞
    if (mission.type === "survive" && !e.active) {
      // –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –≤—Ä–∞–≥–∏ –≤—ã–≥–ª—è–¥—è—Ç —Ç—É—Å–∫–ª–µ–µ
      ctx.fillStyle='#666666'; 
    } else {
      ctx.fillStyle='#ff6666'; 
    }
    ctx.fillRect(e.x, top, e.w, e.h);
    
    // –î–æ–±–∞–≤–ª—è–µ–º –±–ª–∏–∫ –¥–ª—è –æ–±—ä—ë–º–∞
    ctx.fillStyle='rgba(255,255,255,0.3)'; 
    ctx.fillRect(e.x+2, top+2, e.w-4, 4);
    
    // –ì–ª–∞–∑ –≤—Ä–∞–≥–∞
    ctx.fillStyle='#3a0f0f'; 
    ctx.fillRect(e.x+e.w/2-3, top+Math.round(8*S), 6, 6);
    
    // –î–æ–±–∞–≤–ª—è–µ–º —Å–≤–µ—á–µ–Ω–∏–µ
    if (mission.type === "survive") {
      if (e.active) {
        // –ê–∫—Ç–∏–≤–Ω—ã–µ –≤—Ä–∞–≥–∏ - –∫—Ä–∞—Å–Ω–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ
        ctx.globalAlpha = 0.4;
        ctx.fillStyle='#ff0000'; 
        ctx.fillRect(e.x-8, top-8, e.w+16, e.h+16);
      } else {
        // –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –≤—Ä–∞–≥–∏ - —Å–µ—Ä–æ–µ —Å–≤–µ—á–µ–Ω–∏–µ
        ctx.globalAlpha = 0.2;
        ctx.fillStyle='#666666'; 
        ctx.fillRect(e.x-8, top-8, e.w+16, e.h+16);
      }
      ctx.globalAlpha = 1;
    } else if (e.x < canvas.width/DPR + 100*S) {
      ctx.globalAlpha = 0.4 * (1 - (e.x - canvas.width/DPR) / (100*S));
      ctx.fillStyle='#ff0000'; 
      ctx.fillRect(e.x-10, top-10, e.w+20, e.h+20);
      ctx.globalAlpha = 1;
    }
  }

  // === coins
  const COIN_SKINS = ['USDT','BTC','TON'];
  function spawnCoin(){
    const r=Math.round(16*S), top=GROUND_Y - Math.round(80*S) - Math.random()*Math.round(110*S);
    const mission = MISSIONS[currentMission];
    
    // –î–ª—è –º–∏—Å—Å–∏–∏ —Å–±–æ—Ä–∞ —Ç–æ–∫–µ–Ω–æ–≤ - –±–æ–ª—å—à–µ —à–∞–Ω—Å –ø–æ—è–≤–ª–µ–Ω–∏—è –Ω—É–∂–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
    let skin;
    if (mission.type === "collect" && Math.random() < 0.7) {
      skin = mission.targetCoin;
    } else {
      skin = COIN_SKINS[Math.floor(Math.random()*COIN_SKINS.length)];
    }
    
    let spawnX;
    if (mission.type === "survive") {
      // –í –º–∏—Å—Å–∏–∏ –≤—ã–∂–∏–≤–∞–Ω–∏—è –º–æ–Ω–µ—Ç—ã –ø–æ—è–≤–ª—è—é—Ç—Å—è –≤ —Å–ª—É—á–∞–π–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö –Ω–∞ —ç–∫—Ä–∞–Ω–µ
      spawnX = rand(50*S, canvas.width/DPR - 50*S);
    } else {
      // –í –æ–±—ã—á–Ω—ã—Ö –º–∏—Å—Å–∏—è—Ö –º–æ–Ω–µ—Ç—ã –ø–æ—è–≤–ª—è—é—Ç—Å—è —Å–ø—Ä–∞–≤–∞
      spawnX = canvas.width/DPR + rand(0, 120*S);
    }
    
    objects.coins.push({ kind:'coin', x:spawnX, y:top, w:r*2, h:r*2, r,
      skin, spin:rand(0,1000), shimmer:rand(0,1000) });
  }
  function coinPalette(s){
    switch(s){
      case 'USDT': return { inner:'#22ffcc', outer:'#008f73', logo:'#ffffff' };
      case 'BTC':  return { inner:'#ffb347', outer:'#d78100', logo:'#1a1a1a' };
      case 'TON':  return { inner:'#53b6ff', outer:'#0b6ed1', logo:'#ffffff' };
      default:     return { inner:'#ffd94d', outer:'#b88400', logo:'#ffffff' };
    }
  }
  function drawCoinLogo(s){
    switch(s){
      case 'USDT':
        ctx.fillRect(-12*S,-2*S,24*S,4*S); ctx.fillRect(-3*S,-2*S,6*S,16*S); ctx.clearRect(-9*S,6*S,18*S,4*S); break;
      case 'BTC':
        ctx.fillRect(-3*S,-12*S,6*S,24*S);
        ctx.beginPath(); ctx.arc(0,-6*S,8*S,Math.PI*0.9,Math.PI*0.1,false);
        ctx.arc(0, 6*S,8*S,Math.PI*0.9,Math.PI*0.1,false); ctx.fill(); break;
      case 'TON':
        ctx.beginPath(); ctx.moveTo(0,-10*S); ctx.lineTo(10*S,0); ctx.lineTo(0,12*S); ctx.lineTo(-10*S,0); ctx.closePath();
        ctx.strokeStyle=ctx.fillStyle; ctx.stroke(); break;
    }
  }
  function drawCoin(c){
    const {x,y,r,skin}=c, pal=coinPalette(skin);
    const squash=0.12*Math.sin((WORLD.t+c.spin)*0.01);
    ctx.save(); ctx.translate(x+r, y+r); ctx.scale(1+squash,1-squash);
    ctx.rotate(((WORLD.t+c.spin)*0.006)%(Math.PI*2));
    const g=ctx.createRadialGradient(0,0,r*0.25,0,0,r); g.addColorStop(0,pal.inner); g.addColorStop(1,pal.outer);
    ctx.fillStyle=g; ctx.beginPath(); ctx.arc(0,0,r,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(255,255,255,.35)'; ctx.lineWidth=3; ctx.beginPath(); ctx.arc(0,0,r-1.5,0,Math.PI*2); ctx.stroke();
    ctx.save(); ctx.rotate(Math.PI*0.25);
    ctx.globalAlpha=0.25+0.35*((Math.sin((WORLD.t+c.shimmer)*0.008)+1)/2);
    const grd=ctx.createLinearGradient(-r,-r,r,r);
    grd.addColorStop(0,'rgba(255,255,255,0)'); grd.addColorStop(0.5,'rgba(255,255,255,0.8)'); grd.addColorStop(1,'rgba(255,255,255,0)');
    ctx.fillStyle=grd; ctx.fillRect(-r,-r,r*2,r*2); ctx.restore();
    ctx.fillStyle=pal.logo; ctx.strokeStyle=pal.logo; drawCoinLogo(skin);
    ctx.restore();
    }
  
  // === platforms
  function drawPlatform(p) {
    // –§–æ–Ω –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
    ctx.fillStyle = '#2a4a7a';
    ctx.fillRect(p.x, p.y, p.w, p.h);
    
    // –†–∞–º–∫–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ã
    ctx.strokeStyle = '#4a6a9a';
    ctx.lineWidth = 2;
    ctx.strokeRect(p.x, p.y, p.w, p.h);
    
    // –ë–ª–∏–∫–∏ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–µ
    ctx.fillStyle = 'rgba(255,255,255,0.2)';
    ctx.fillRect(p.x + 2, p.y + 2, p.w - 4, 3);
  }
  
  // === bonus
  function drawBonus(b) {
    if (b.caught) return;
    
    const x = b.x, y = b.y, r = b.w/2;
    
    ctx.save();
    ctx.translate(x + r, y + r);
    ctx.rotate(((WORLD.t + b.spin) * 0.01) % (Math.PI * 2));
    
    // –ó–æ–ª–æ—Ç–æ–π –≥—Ä–∞–¥–∏–µ–Ω—Ç
    const g = ctx.createRadialGradient(0, 0, r*0.25, 0, 0, r);
    g.addColorStop(0, '#ffd700');
    g.addColorStop(1, '#ff8c00');
    
    ctx.fillStyle = g;
    ctx.beginPath();
    ctx.arc(0, 0, r, 0, Math.PI * 2);
    ctx.fill();
    
    // –ë–ª–∏–∫–∏
    ctx.strokeStyle = 'rgba(255,255,255,0.8)';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.arc(0, 0, r-1.5, 0, Math.PI * 2);
    ctx.stroke();
    
    // –ê–Ω–∏–º–∞—Ü–∏—è –º–µ—Ä—Ü–∞–Ω–∏—è
    ctx.globalAlpha = 0.6 + 0.4 * ((Math.sin((WORLD.t + b.shimmer) * 0.01) + 1) / 2);
    const grd = ctx.createLinearGradient(-r, -r, r, r);
    grd.addColorStop(0, 'rgba(255,255,255,0)');
    grd.addColorStop(0.5, 'rgba(255,255,255,0.9)');
    grd.addColorStop(1, 'rgba(255,255,255,0)');
    ctx.fillStyle = grd;
    ctx.fillRect(-r, -r, r*2, r*2);
    
    ctx.restore();
  }
  
  // === particles (–ª–∞–∫–æ–Ω–∏—á–Ω–æ)
  function spawnBurst(x,y,color,count=8){
    for(let i=0;i<count;i++)
      objects.particles.push({x,y,vx:rand(-2*S,2*S),vy:rand(-3*S,-1*S),t:0,life:rand(300,700),color});
  }
  function drawParticles(dt){
    for(let i=objects.particles.length-1;i>=0;i--){
      const p=objects.particles[i];
      p.t+=dt; p.x+=p.vx; p.y+=p.vy; p.vy+=0.08*S;
      const a=Math.max(0,1-p.t/p.life);
      if(a<=0){ objects.particles.splice(i,1); continue; }
      ctx.globalAlpha=a; ctx.fillStyle=p.color; ctx.fillRect(p.x,p.y,3,3); ctx.globalAlpha=1;
    }
  }

  // === input
  const jump = ()=>{ if(alive && player.onGround){ player.vy=JUMP_VELOCITY; player.onGround=false; } };
  
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–ø–æ–≤ –¥–ª—è –¥–≤–∏–∂–µ–Ω–∏—è –≤–ª–µ–≤–æ/–≤–ø—Ä–∞–≤–æ –≤ –º–∏—Å—Å–∏–∏ –≤—ã–∂–∏–≤–∞–Ω–∏—è –∏ –ø—Ä—ã–∂–∫–æ–≤
      canvas.addEventListener('pointerdown', (e) => {
        if (!alive) return;
        
        const mission = MISSIONS[currentMission];
        if (mission.type === "survive" || mission.type === "jump" || mission.type === "chase") {
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–æ—Ä–æ–Ω—É —Ç–∞–ø–∞
          const tapX = e.clientX;
          const screenCenter = window.innerWidth / 2;
          
          if (tapX < screenCenter) {
            // –¢–∞–ø —Å–ª–µ–≤–∞ - –¥–≤–∏–∂–µ–Ω–∏–µ –≤–ª–µ–≤–æ
            player.vx = -3 * S;
          } else {
            // –¢–∞–ø —Å–ø—Ä–∞–≤–∞ - –¥–≤–∏–∂–µ–Ω–∏–µ –≤–ø—Ä–∞–≤–æ
            player.vx = 3 * S;
          }
          
          // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—É—é —Å–∫–æ—Ä–æ—Å—Ç—å —á–µ—Ä–µ–∑ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è
          setTimeout(() => { player.vx = 0; }, 200);
        } else {
          // –û–±—ã—á–Ω—ã–π –ø—Ä—ã–∂–æ–∫ –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–∏—Å—Å–∏–π
          jump();
        }
      }, { passive:true });
  document.addEventListener('keydown', e=>{
    if(e.code==='Space'||e.code==='ArrowUp'){ e.preventDefault(); jump(); }
    if(e.code==='KeyR') reset();
    if(e.code==='KeyP') { paused=!paused; btnPause.textContent = paused ? '‚ñ∂ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å' : '‚è∏ –ü–∞—É–∑–∞'; }
    if(e.code==='KeyK') { catColorIndex=(catColorIndex+1)%CAT_COLORS.length; }
  });

  // === bottom buttons
  // –§—É–Ω–∫—Ü–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –º–∏—Å—Å–∏–π
  function showMissionModal() {
    missionList.innerHTML = '';
    MISSIONS.forEach((mission, index) => {
      const item = document.createElement('div');
      item.className = `mission-item ${index === currentMission ? 'active' : ''}`;
      item.innerHTML = `
        <div class="icon">${mission.icon}</div>
        <div class="name">${mission.name}</div>
        <div class="desc">${mission.description}</div>
      `;
      item.onclick = () => {
        currentMission = index;
        reset();
        hideMissionModal();
      };
      missionList.appendChild(item);
    });
    missionModal.style.display = 'flex';
  }
  
  function hideMissionModal() {
    missionModal.style.display = 'none';
  }
  
  btnRestart.onclick = ()=>{ reset(); };
  btnPause.onclick   = ()=>{ paused=!paused; btnPause.textContent = paused ? '‚ñ∂ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å' : '‚è∏ –ü–∞—É–∑–∞'; };
  btnColor.onclick   = ()=>{ catColorIndex=(catColorIndex+1)%CAT_COLORS.length; };
  btnMission.onclick = showMissionModal;
  missionClose.onclick = hideMissionModal;
  
  // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  missionModal.onclick = (e) => {
    if (e.target === missionModal) hideMissionModal();
  };

  // === loop
  let last = performance.now();
  function loop(now){
    const dt = now - last; last = now;

    if(!paused && alive){
      const mission = MISSIONS[currentMission];
      
      if (mission.type === "survive") {
        // –í –º–∏—Å—Å–∏–∏ –≤—ã–∂–∏–≤–∞–Ω–∏—è –≤—Ä–µ–º—è –∏–¥–µ—Ç, –Ω–æ –º–∏—Ä –Ω–µ –¥–≤–∏–∂–µ—Ç—Å—è
        WORLD.t += dt;
        // –°–∫–æ—Ä–æ—Å—Ç—å –º–∏—Ä–∞ –æ—Å—Ç–∞–µ—Ç—Å—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–π –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ —Ñ–æ–Ω–∞
        WORLD.speed = START_SPEED;
      } else {
        // –û–±—ã—á–Ω—ã–µ –º–∏—Å—Å–∏–∏ - –º–∏—Ä –¥–≤–∏–∂–µ—Ç—Å—è
        WORLD.t += dt;
        WORLD.speed += SPEEDUP * dt;
      }

      const currentCooldown = getCurrentSpawnCooldown();
      if(now - lastSpawn.coin  > currentCooldown.coin)  { spawnCoin();  lastSpawn.coin=now; }
      
      // –í –º–∏—Å—Å–∏–∏ –≤—ã–∂–∏–≤–∞–Ω–∏—è –≤—Ä–∞–≥–∏ –Ω–µ –ø–æ—è–≤–ª—è—é—Ç—Å—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ
      if(mission.type !== "survive" && now - lastSpawn.enemy > currentCooldown.enemy) { 
        spawnEnemy(); 
        lastSpawn.enemy=now; 
      }

      player.vy += GRAVITY; player.y += player.vy;
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–ª–ª–∏–∑–∏–π —Å –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞–º–∏
      if (mission.type === "jump") {
        player.onGround = false;
        for (let i = 0; i < objects.platforms.length; i++) {
          const platform = objects.platforms[i];
          if (player.x < platform.x + platform.w && 
              player.x + player.w > platform.x &&
              player.y + player.h >= platform.y &&
              player.y + player.h <= platform.y + platform.h + 5) {
            player.y = platform.y - player.h;
            player.vy = 0;
            player.onGround = true;
            break;
          }
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–µ–º–ª–∏
        if (player.y >= GROUND_Y) {
          player.y = GROUND_Y;
          player.vy = 0;
          player.onGround = true;
        }
      } else {
        // –û–±—ã—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–µ–º–ª–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö –º–∏—Å—Å–∏–π
        if(player.y >= GROUND_Y){ player.y=GROUND_Y; player.vy=0; player.onGround=true; }
      }
      
      // –ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
      player.x += player.vx;
      
      // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è –∏–≥—Ä–æ–∫–∞
      const minX = 20*S;
      const maxX = canvas.width/DPR - player.w - 20*S;
      if (player.x < minX) player.x = minX;
      if (player.x > maxX) player.x = maxX;
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —É–±–µ–≥–∞—é—â–µ–≥–æ –±–æ–Ω—É—Å–∞
      if (mission.type === "chase" && objects.bonus && !objects.bonus.caught) {
        // –ë–æ–Ω—É—Å –¥–≤–∏–∂–µ—Ç—Å—è –≤–ª–µ–≤–æ –±—ã—Å—Ç—Ä–µ–µ –∏–≥—Ä–æ–∫–∞
        objects.bonus.x -= objects.bonus.speed;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏—è —Å –±–æ–Ω—É—Å–æ–º
        if (aabb(objects.bonus, player)) {
          objects.bonus.caught = true;
          mission.progress = 1; // –ú–∏—Å—Å–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
          spawnBurst(objects.bonus.x + objects.bonus.w/2, objects.bonus.y + objects.bonus.h/2, '#ffd700', 20);
        }
        
        // –ï—Å–ª–∏ –±–æ–Ω—É—Å —É—à–µ–ª –∑–∞ –ª–µ–≤—ã–π –∫—Ä–∞–π —ç–∫—Ä–∞–Ω–∞ - –º–∏—Å—Å–∏—è –ø—Ä–æ–≤–∞–ª–µ–Ω–∞
        if (objects.bonus.x + objects.bonus.w < -50*S) {
          alive = false;
          missionActive = false;
          updateMainButton(coins, alive);
        }
      }
      
      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –∑–µ–º–ª–µ –¥–ª—è –º–∏—Å—Å–∏–∏ –ø—Ä—ã–∂–∫–æ–≤
      if (mission.type === "jump") {
        if (player.onGround) {
          groundTime += dt;
          if (groundTime > 2000) { // 2 —Å–µ–∫—É–Ω–¥—ã
            alive = false;
            missionActive = false;
            updateMainButton(coins, alive);
            // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ –ø—Ä–æ–≤–∞–ª–µ –º–∏—Å—Å–∏–∏
            spawnBurst(player.x + player.w/2, player.y - player.h/2, '#ff6666', 15);
          }
        } else {
          groundTime = 0;
        }
      }

      for(let i=objects.coins.length-1;i>=0;i--){
        const c=objects.coins[i];
        
        if (mission.type === "survive") {
          // –í –º–∏—Å—Å–∏–∏ –≤—ã–∂–∏–≤–∞–Ω–∏—è –º–æ–Ω–µ—Ç—ã –Ω–µ –¥–≤–∏–∂—É—Ç—Å—è
          // –û–Ω–∏ –æ—Å—Ç–∞—é—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ –¥–ª—è —Å–±–æ—Ä–∞
        } else {
          // –í –æ–±—ã—á–Ω—ã—Ö –º–∏—Å—Å–∏—è—Ö –º–æ–Ω–µ—Ç—ã –¥–≤–∏–∂—É—Ç—Å—è –≤–ª–µ–≤–æ
          c.x -= WORLD.speed;
        }
        
        if(aabb(c,player)){
          coins++; coinsEl.textContent=coins; updateMainButton(coins, alive);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –º–∏—Å—Å–∏–∏ —Å–±–æ—Ä–∞ —Ç–æ–∫–µ–Ω–æ–≤
          if (MISSIONS[currentMission].type === "collect" && c.skin === MISSIONS[currentMission].targetCoin) {
            MISSIONS[currentMission].progress++;
          }
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –º–∏—Å—Å–∏–∏ –ø—Ä—ã–∂–∫–æ–≤
          if (MISSIONS[currentMission].type === "jump") {
            MISSIONS[currentMission].progress++;
          }
          
          spawnBurst(c.x+c.r, c.y+c.r, 'rgba(255,255,255,.9)', 10);
          objects.coins.splice(i,1);
        } else if(c.x + c.w < -10 && mission.type !== "survive" && mission.type !== "chase") objects.coins.splice(i,1);
      }
      for(let i=objects.enemies.length-1;i>=0;i--){
        const e=objects.enemies[i];
        const mission = MISSIONS[currentMission];
        
        if (mission.type === "survive") {
          // –í –º–∏—Å—Å–∏–∏ –≤—ã–∂–∏–≤–∞–Ω–∏—è –≤—Ä–∞–≥–∏ –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏–∏
          const dx = player.x - e.x;
          const dy = player.y - e.y;
          const distance = Math.sqrt(dx*dx + dy*dy);
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∞–∫—Ç–∏–≤–∞—Ü–∏—é –≤—Ä–∞–≥–∞
          if (!e.active && distance < e.activationDistance) {
            e.active = true;
          }
          
          // –î–≤–∏–∂–µ–Ω–∏–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –≤—Ä–∞–≥ –∞–∫—Ç–∏–≤–µ–Ω
          if (e.active) {
            if (distance > 0) {
              // –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫ –∏–≥—Ä–æ–∫—É
              e.vx = (dx / distance) * e.speed;
              e.vy = (dy / distance) * e.speed;
            }
            
            // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–∑–∏—Ü–∏–∏ –≤—Ä–∞–≥–∞
            e.x += e.vx;
            e.y += e.vy;
          }
          
          // –£–¥–∞–ª—è–µ–º –≤—Ä–∞–≥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —É—à–ª–∏ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —ç–∫—Ä–∞–Ω–∞
          if (e.x < -50*S || e.x > canvas.width/DPR + 50*S || 
              e.y < -50*S || e.y > canvas.height/DPR + 50*S) {
            objects.enemies.splice(i,1);
            continue;
          }
        } else {
          // –û–±—ã—á–Ω–æ–µ –¥–≤–∏–∂–µ–Ω–∏–µ –≤—Ä–∞–≥–æ–≤ –≤–ª–µ–≤–æ
          e.x -= WORLD.speed*1.05;
        }
        
        if(aabb(e,player)){ 
          alive=false; 
          missionActive = false;
          updateMainButton(coins, alive); 
          // –î–æ–±–∞–≤–ª—è–µ–º —ç—Ñ—Ñ–µ–∫—Ç –ø—Ä–∏ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–∏
          spawnBurst(player.x + player.w/2, player.y - player.h/2, '#ff6666', 15);
        }
        else if(e.x + e.w < -10 && mission.type !== "survive" && mission.type !== "chase") objects.enemies.splice(i,1);
      }
    }

    // render
    ctx.clearRect(0,0,canvas.width/DPR,canvas.height/DPR);
    drawBackground();
    objects.coins.forEach(drawCoin);
    objects.enemies.forEach(drawEnemy);
    objects.platforms.forEach(drawPlatform);
    if (objects.bonus) drawBonus(objects.bonus);
    drawParticles(dt);
    drawPicoCat();

    // –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –º–∏—Å—Å–∏–∏
    if (missionActive) {
      const mission = MISSIONS[currentMission];
      let progress = 0;
      let displayText = "";
      
      if (mission.type === "time") {
        progress = Math.min(1, (Date.now() - missionStartTime) / mission.target);
        const timeLeft = Math.max(0, Math.ceil((mission.target - (Date.now() - missionStartTime)) / 1000));
        displayText = `${timeLeft}—Å`;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∏—Å—Å–∏–∏ –≤—Ä–µ–º–µ–Ω–∏
        if (progress >= 1) {
          missionActive = false;
          alive = false;
        }
      } else if (mission.type === "collect") {
        progress = Math.min(1, mission.progress / mission.target);
        displayText = `${mission.progress}/${mission.target} ${mission.targetCoin}`;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∏—Å—Å–∏–∏ —Å–±–æ—Ä–∞
        if (mission.progress >= mission.target) {
          missionActive = false;
          alive = false;
        }
      } else if (mission.type === "survive") {
        progress = Math.min(1, (Date.now() - missionStartTime) / mission.target);
        const timeLeft = Math.max(0, Math.ceil((mission.target - (Date.now() - missionStartTime)) / 1000));
        displayText = `${timeLeft}—Å`;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∏—Å—Å–∏–∏ –≤—ã–∂–∏–≤–∞–Ω–∏—è
        if (progress >= 1) {
          missionActive = false;
          alive = false;
        }
      } else if (mission.type === "jump") {
        progress = Math.min(1, mission.progress / mission.target);
        const timeOnGround = Math.max(0, Math.ceil((2000 - groundTime) / 1000));
        displayText = `${mission.progress}/${mission.target} –º–æ–Ω–µ—Ç (${timeOnGround}—Å –Ω–∞ –∑–µ–º–ª–µ)`;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∏—Å—Å–∏–∏ –ø—Ä—ã–∂–∫–æ–≤
        if (mission.progress >= mission.target) {
          missionActive = false;
          alive = false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–≤–∞–ª–∞ –º–∏—Å—Å–∏–∏ (–≤—Ä–µ–º—è –Ω–∞ –∑–µ–º–ª–µ)
        if (groundTime > 2000) {
          missionActive = false;
          alive = false;
        }
      } else if (mission.type === "chase") {
        progress = Math.min(1, (Date.now() - missionStartTime) / mission.target);
        const timeLeft = Math.max(0, Math.ceil((mission.target - (Date.now() - missionStartTime)) / 1000));
        displayText = `${timeLeft}—Å - –î–æ–≥–æ–Ω–∏ –∑–æ–ª–æ—Ç—É—é –º–æ–Ω–µ—Ç—É!`;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –º–∏—Å—Å–∏–∏ –≥–æ–Ω–∫–∏
        if (mission.progress >= 1) {
          missionActive = false;
          alive = false;
        }
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–æ–≤–∞–ª–∞ –º–∏—Å—Å–∏–∏ (–≤—Ä–µ–º—è –∏—Å—Ç–µ–∫–ª–æ)
        if (progress >= 1) {
          missionActive = false;
          alive = false;
        }
      }
      
      const barWidth = canvas.width/DPR - 40*S;
      const barHeight = 8*S;
      const barY = canvas.height/DPR - 20*S;
      
      // –§–æ–Ω –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–∞
      ctx.fillStyle = 'rgba(255,255,255,0.2)';
      ctx.fillRect(20*S, barY, barWidth, barHeight);
      
      // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
      ctx.fillStyle = '#5cc8ff';
      ctx.fillRect(20*S, barY, barWidth * progress, barHeight);
      
      // –¢–µ–∫—Å—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å–∞
      ctx.fillStyle = '#ffffff';
      ctx.font = `${Math.round(12*S)}px system-ui`;
      ctx.textAlign = 'center';
      ctx.fillText(displayText, canvas.width/DPR/2, barY - 5*S);
      ctx.textAlign = 'left';
    }
    
    if(!alive){
      const mission = MISSIONS[currentMission];
      if (missionActive) {
        ctx.fillStyle='#ffb3c0'; ctx.font=`${Math.round(18*S)}px system-ui, sans-serif`;
        ctx.fillText('–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞ ‚Äî –†–µ—Å—Ç–∞—Ä—Ç', Math.round(20*S), Math.round(40*S));
      } else {
        ctx.fillStyle='#5cc8ff'; ctx.font=`${Math.round(20*S)}px system-ui, sans-serif`;
        ctx.fillText('–ú–∏—Å—Å–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!', Math.round(20*S), Math.round(40*S));
        ctx.fillStyle='#ffffff'; ctx.font=`${Math.round(16*S)}px system-ui, sans-serif`;
        ctx.fillText(`–°–æ–±—Ä–∞–Ω–æ –º–æ–Ω–µ—Ç: ${coins}`, Math.round(20*S), Math.round(65*S));
        
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –º–∏—Å—Å–∏–∏
        ctx.fillStyle='#5cc8ff'; ctx.font=`${Math.round(14*S)}px system-ui, sans-serif`;
        ctx.fillText(mission.name, Math.round(20*S), Math.round(85*S));
      }
    }
    requestAnimationFrame(loop);
  }

  // init
  window.addEventListener('resize', resize);
  resize();
  reset();
  bindMainButton(()=>coins, ()=>alive);
  requestAnimationFrame(t=>{ last=t; loop(t); });
})();
</script>
</body>
</html>
